let subs=[],txs=[],fightLogs=[],fightInterval=10;const fightAddress=$("#fight-address"),fightResult=$("#table-logs tbody");async function subscribe(e){console.log("Subscribed:",e),subs[e]=setInterval(async()=>{try{const t=await getLatestBlock(),n=await getPastEvents("FightOutcome",t.number-5,t.number,"0x39bea96e13453ed52a734b6aceed4c41f57b2271",["0x7a58aac6530017822bf3210fccef7efa31f56277f19966bc887bfb11f40ca96d",web3.eth.abi.encodeParameter("address",e)]);n.length>0&&n.forEach(async e=>{if(!txs.includes(e.transactionHash)){const{character:t,enemyRoll:n,playerRoll:s,owner:i,skillGain:a,xpGain:r,weapon:o}=e.returnValues,l=await getTransaction(e.transactionHash),d=await getTransactionReceipt(e.transactionHash),c=l.gasPrice*d.gasUsed;fightResult.append(`<tr>\n                                                <td class='text-white text-center'>${addressPrivacy(i)}</td>\n                                                <td class='text-white text-center'>${parseInt(s)>parseInt(n)?"Win":"Lost"}</td>\n                                                <td class='text-white text-center'>${t}</td>\n                                                <td class='text-white text-center'>${o}</td>\n                                                <td class='text-white text-center'>${s}</td>\n                                                <td class='text-white text-center'>${n}</td>\n                                                <td class='text-white text-center'>${web3.utils.fromWei(BigInt(a).toString(),"ether")}</td>\n                                                <td class='text-white text-center'>${r}</td>\n                                                <td class='text-white text-center'>${web3.utils.fromWei(BigInt(c).toString(),"ether")}</td>\n                                            </tr>`),txs.push(e.transactionHash),fightLogs.push(`${i},${parseInt(s)>parseInt(n)?"Win":"Lost"},${t},${o},${s},${n},${web3.utils.fromWei(BigInt(a).toString(),"ether")},${r},${web3.utils.fromWei(BigInt(c).toString(),"ether")}`)}})}catch(e){console.log(e)}},1e3*fightInterval)}async function addAccount(){var e=$("#logger-address").val().trim();!Object.keys(subs).includes(e)&&isAddress(e)&&(await subscribe(e),fightAddress.append(`${e}\n`),$("#modal-add-account").modal("hide"))}function exportList(){var e=fightAddress.val().split("\n");if(e.splice(e.length-1,1),e.length>0){var t=e.join("\n"),n=new Blob([t],{type:"text/plain"}),s=window.URL.createObjectURL(n),i=document.createElement("a");i.download=`CBTracker-Address-List-${(new Date).getTime()}.txt`,i.innerHTML="Download File",i.href=s,i.onclick=function(){document.body.removeChild(event.target)},i.style.display="none",document.body.appendChild(i),i.click()}}function exportLogs(){if(fightLogs.length>0){var e=fightLogs.join("\n"),t=new Blob([e],{type:"text/plain"}),n=window.URL.createObjectURL(t),s=document.createElement("a");s.download=`CBTracker-Fight-Logs-${(new Date).getTime()}.txt`,s.innerHTML="Download File",s.href=n,s.onclick=function(){document.body.removeChild(event.target)},s.style.display="none",document.body.appendChild(s),s.click()}}function importList(){if(!(window.File&&window.FileReader&&window.FileList&&window.Blob))return alert("The File APIs are not fully supported in this browser.");var e=document.getElementById("file-import");if(!e)return alert("Um, couldn't find the fileinput element.");if(!e.files)return alert("This browser doesn't seem to support the `files` property of file inputs.");if(!e.files[0])return alert("Please select a file before clicking 'Import'");if("text/plain"===e.files[0].type){var t=e.files[0],n=new FileReader;n.readAsText(t),n.addEventListener("load",function(){var e=n.result.split("\n");(e=e.map(e=>e.replace(/\r?\n|\r/g,""))).length&&e.forEach(async e=>{!Object.keys(subs).includes(e)&&isAddress(e)&&(await subscribe(e),fightAddress.append(`${e}\n`))}),$("#modal-import").modal("hide")})}else alert("Please import a valid json/text file")}function copy_address_to_clipboard(){navigator.clipboard.writeText("0x2548696795a3bCd6A8fAe7602fc26DD95A612574").then(e=>alert("Copied Address"),e=>alert("Fail\n"+e))}function addressPrivacy(e){return`${e.substr(0,6)}...${e.substr(-4,4)}`}window.addEventListener("beforeunload",function(e){fightResult.val()&&(e.preventDefault(),e.returnValue="Your fight logs will be lost. Please save them before closing/refreshing this page")}),$("#modal-add-account").on("shown.bs.modal",function(e){$("#logger-address").val("")});